<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analisis Peta Bahaya Banjir Kecamatan Depok ‚Äî Tabel & Grafik Sub-Parameter</title>

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
  --bg-main:#FBF4E9;        /* krem utama */
  --bg-soft:#F5EBDD;        /* layer lembut */
  --card:#FFFDF9;           /* isi card terang */

  --primary:#2E2A72;        /* ungu identitas */
  --accent:#4F7DF3;         /* biru interaksi */
  --highlight:#F4A261;

  --text:#1F1F1F;
  --muted:#6B6B6B;

  --border:rgba(0,0,0,.08);
  --shadow:0 10px 30px rgba(0,0,0,.08);
}



*{box-sizing:border-box}
#mobileWarning{
  display:none; /* default tersembunyi */
  position:fixed;
  inset:0;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:rgba(251,244,233,0.92);
  z-index:9999;
  padding:24px;
  text-align:center;
  font-family:system-ui, sans-serif;
  align-items:center;
  justify-content:center;
}
@media (max-width:768px){
  #mobileWarning{
    display:flex; /* hanya muncul di HP */
  }
}

/* Box isi pesan */
#mobileWarning .box{
  width:100%;
  max-width:380px; /* pas buat layar HP */
  background:#111827;
  padding:20px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
  animation:fadeIn .4s ease;
}

#mobileWarning h2{
  margin:0 0 10px;
  font-size:1.1rem;
}

#mobileWarning p{
  font-size:.9rem;
  line-height:1.6;
  color:rgba(251,244,233,0.92);
}

#mobileWarning b{
  color:#38bdf8;
}

#mobileWarning button{
  margin-top:14px;
  padding:8px 14px;
  border:none;
  border-radius:8px;
  background:#38bdf8;
  color:#0f172a;
  font-weight:600;
  cursor:pointer;
}

/* Animasi halus */
@keyframes fadeIn{
  from{opacity:0; transform:translateY(10px)}
  to{opacity:1; transform:translateY(0)}
}
@media (max-width: 768px){
  body.mobile-mode .stack,
  body.mobile-mode h1,
  body.mobile-mode .subtle{
    display:block;
  }

  body:not(.mobile-mode) .stack,
  body:not(.mobile-mode) h1,
  body:not(.mobile-mode) .subtle{
    display:none;
  }
}

/* body */
body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: linear-gradient(135deg, var(--bg-main), #fdf8ef);

  color:var(--text);
  padding:clamp(12px, 3vw, 24px);
}


    h1{
      margin:0 0 18px 0;
      font-weight:700;
      letter-spacing:.3px;
      text-align:center;
    }
    .subtle{color:var(--muted); font-size:.95rem; text-align:center; margin-top:4px;}
h1{
  margin-bottom:6px;
  color: var(--primary);
  font-weight:700;
  font-size: clamp(1.1rem, 2.4vw, 1.6rem);
}

.subtle{
  margin-bottom:10px;
}

   .card{
  background: var(--card);
  backdrop-filter: blur(8px);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
  transition: all .25s ease;
}

.card:hover{
  transform: translateY(-1px);
  box-shadow: 0 10px 26px rgba(0,0,0,.10);
}
    .stack{
  display:grid;
  gap:clamp(14px, 2vw, 22px);
}

    .filters{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
  justify-content:center;
}

  .control{
  display:flex;
  align-items:center;
  gap:8px;
  background: var(--card);
  border:1px solid var(--border);
  padding:8px 12px;
  border-radius:10px;
  color:var(--text);
}

.control label{
  font-size:.9rem;
  color:var(--muted);
}

select{
  appearance:none;
   background:white;
  color:var(--text);
  border:1px solid var(--border);
  padding:8px 10px;
  border-radius:8px;
}
    /* DataTables theming */
    table.dataTable{
  background: var(--card);
   border:1px solid var(--border);
  color:var(--text);
  border-radius:12px;
  overflow:hidden;
}

th{
  background: var(--bg-soft) !important;
  color: var(--primary);
}

/* ===== DataTables Controls (FIX BIAR ELEGAN) ===== */

.dataTables_wrapper .dataTables_filter input{
  background: var(--card) !important;
  color: var(--text) !important;
  border: 1px solid var(--border) !important;
  border-radius: 8px !important;
  padding: 6px 10px !important;
  outline: none;
}

.dataTables_wrapper .dataTables_filter input:focus{
  border-color: var(--primary) !important;
  box-shadow: 0 0 0 2px rgba(46,42,114,0.15);
}

/* Dropdown "Tampilkan entri" */

.dataTables_wrapper .dataTables_length select{
  background: var(--card) !important;
  color: var(--text) !important;
  border: 1px solid var(--border) !important;
  border-radius: 8px !important;
  padding: 4px 6px !important;
}

/* Label teks */
.dataTables_wrapper .dataTables_filter label,
.dataTables_wrapper .dataTables_length label{
  color: var(--muted) !important;
  font-size: 0.85rem;
}

    canvas{
   background: var(--bg-soft);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px;
}


    .legendNote{font-size:.9rem; color:var(--muted); text-align:center; margin-top:8px;}
    .detailCard{padding:0}
    .detailHeader{
      padding:12px 16px; border-bottom:1px solid var(--border); background: var(--bg-soft); color: var(--primary); border-radius:12px 12px 0 0;
      font-weight:600;
    }
    #detailTable{width:100%; border-collapse:collapse}
    #detailTable th, #detailTable td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left}
    #detailTable tr:hover{background:rgba(110,193,255,.35)}
    .swatch{display:inline-block; width:12px; height:12px; border-radius:3px; vertical-align:middle; margin-right:8px; border:1px solid #0004}
    .empty{padding:14px 16px; color:var(--muted)}
    /* ===== Highlight effect saat grafik diklik ===== */
@keyframes focusGlow {
  0%   { box-shadow: 0 0 0 rgba(110,193,255,0); }
  40%  { box-shadow: 0 0 0 6px rgba(110,193,255,.35); }
  100% { box-shadow: 0 0 0 rgba(110,193,255,0); }
}

.detail-focus {
  animation: focusGlow 1.2s ease-out;
}
/* ===== Section divider (professional cue) ===== */
.sectionBreak{
  display:flex;
  align-items:center;
  gap:12px;
  margin:28px 0 12px;
  color:var(--muted);
  font-size:.8rem;
  text-transform:uppercase;
  letter-spacing:.14em;
}

.sectionBreak::before,
.sectionBreak::after{
  content:"";
  flex:1;
  height:1px;
  background:linear-gradient(90deg, transparent, var(--border), transparent);
}

/* =========================
   MOBILE MODE ‚Äî SUPER COMPACT
   ========================= */
@media (max-width: 600px){

  /* ===== GLOBAL ===== */
  body{
    padding: 10px;
  }

  h1{
    font-size: 0.95rem;
    line-height: 1.3;
    margin-bottom: 10px;
  }

  .subtle{
    font-size: 0.75rem;
  }

  /* ===== CARD ===== */
  .card{
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,.06);
  }

  .stack{
    gap: 12px;
  }

  /* ===== FILTER ===== */
  .control{
    padding: 6px 8px;
    gap: 6px;
  }

  .control label{
    font-size: 0.75rem;
  }

  select{
    font-size: 0.8rem;
    padding: 6px 8px;
  }

  /* ===== TABLE ===== */
  table.dataTable{
    font-size: 11px;
    min-width: 850px;
  }

  th, td{
    padding: 5px 6px !important;
  }

  /* ===== SECTION BREAK ===== */
  .sectionBreak{
    font-size: 0.65rem;
    margin: 16px 0 8px;
  }
  .sectionBreak{
  font-weight:600;
  color:#475569;
}

.chartCard{
  position: relative;
}

.chartCard::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:16px;
  background: linear-gradient(120deg, transparent, rgba(37,99,235,0.06), transparent);
  pointer-events:none;
}

  /* ===== GRAFIK ===== */
  .chartCard{
    padding: 10px;
     border:1px solid var(--border);
  background: var(--card);
  }

  #banjirChart{
    width: 100% !important;
    height: 520px !important; /* ‚¨ÖÔ∏è INI KUNCI: KE BAWAH */
  }

  /* ===== DETAIL ===== */
  .detailHeader{
    font-size: 0.8rem;
    padding: 8px 10px;
  }

  #detailTable th,
  #detailTable td{
    font-size: 11px;
    padding: 6px 8px;
  }

  .legendNote{
    font-size: 0.7rem;
  }
}
@media (max-width: 600px){

  /* ===== TABLE COMPACT MODE ===== */
  .tableWrap{
    overflow-x:auto;
    -webkit-overflow-scrolling: touch;
  }

  table.dataTable{
    min-width: unset !important;
    width: 100% !important;
    font-size: 10px;
  }

  table.dataTable th,
  table.dataTable td{
    padding: 4px 6px !important;
    white-space: nowrap;
  }

  /* SEMBUNYIKAN KOLOM TIDAK KRUSIAL */
  #banjirTable th:nth-child(2),
  #banjirTable td:nth-child(2),  /* Tutupan Lahan */

  #banjirTable th:nth-child(3),
  #banjirTable td:nth-child(3),  /* Kerapatan Sungai */

  #banjirTable th:nth-child(6),
  #banjirTable td:nth-child(6),  /* Curah Hujan */

  #banjirTable th:nth-child(7),
  #banjirTable td:nth-child(7),  /* Lereng */

  #banjirTable th:nth-child(8),
  #banjirTable td:nth-child(8)   /* Ketinggian */
  {
    display:none;
  }
}

/* ===== Panel Interpretasi Modern ===== */
.interpretBox{
  max-width: 820px;
  margin: 20px auto 20px;
 background: var(--bg-soft);
  border:1px solid var(--border);
  border-radius: 10px;
  padding: 10px 12px;
  display: flex;
  gap: 10px;
  align-items: flex-start;
  font-size: .82rem;
  line-height: 1.5;
  color: var(--muted);
}

.interpretIcon{
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: var(--accent);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: .75rem;
  flex-shrink: 0;
  margin-top: 2px;
}

.interpretBox b{
  color: var(--text);
}

/* Mobile tuning */
@media (max-width:600px){
  .interpretBox{
    font-size: .72rem;
    padding: 8px 10px;
  }

  .interpretIcon{
    width:18px;
    height:18px;
    font-size:.65rem;
  }
}
.paramLegend{
  display:flex;
  flex-wrap:wrap;
  gap:10px 14px;
  justify-content:center;
  margin:10px 0 6px;
  font-size:.78rem;
  color:var(--muted);
}

.paramItem{
  display:flex;
  align-items:center;
  gap:6px;
  background: var(--bg-soft);
  border:1px solid var(--border);
  padding:4px 8px;
  border-radius:8px;
}

.paramColor{
  width:10px;
  height:10px;
  border-radius:2px;
  flex-shrink:0;
}

  </style>
</head>
<body>
    <div id="mobileWarning">
  <div class="box">
    <h2>‚ö†Ô∏è Tampilan Terbaik di Layar Besar</h2>
    <p>
      Dashboard analisis ini memiliki tabel dan grafik yang kompleks.<br><br>
      Agar semua informasi terlihat jelas, silakan buka menggunakan <b>Laptop/PC</b><br>
      atau aktifkan <b>Mode Desktop</b> di browser HP Anda.
    </p>
    <button onclick="enableMobileMode()">
      Tetap Lanjut di HP
    </button>
  </div>
</div>


  <h1>Analisis Bahaya Banjir Kecamatan Depok, Kabupaten Sleman</h1>
  <div class="subtle">Tabel atribut & visualisasi grouped-stacked berdasarkan <em>Kelas Bahaya Banjir</em> (Rendah, Sedang, Tinggi) dengan tumpukan <em>sub-parameter</em>.</div>
<div class="interpretBox" style="max-width:900px;">
  <div class="interpretIcon">i</div>
  <div>
    <b>Panduan Singkat Dashboard:</b><br>
    <p>Tabel menyajikan data atribut hasil analisis bahaya banjir yang dapat difilter berdasarkan Desa/Kelurahan 
    dan kelas bahaya.</p>
    <p>Grafik menampilkan distribusi luasan (Km¬≤) sub-parameter pada setiap kelas bahaya banjir. 
        Grafik dapat difilter berdasarkan Desa/Kelurahan.
    Pengguna dapat mengklik elemen grafik untuk melihat rincian sub-parameter secara lebih detail pada panel di bawah.
    </p></div>
</div>

  <div class="stack" style="max-width:1200px; margin:18px auto;">
    <!-- ==== TABEL + FILTER ==== -->
    <div class="card">
      <div class="filters" style="margin-bottom:10px">
        <div class="control">
          <label for="filterKec">Filter Desa/Kelurahan</label>
          <select id="filterKec"></select>
        </div>
        <div class="control">
          <label for="filterKelas">Filter Kelas Bahaya Banjir</label>
          <select id="filterKelas">
            <option value="">Semua</option>
            <option value="Rendah">Rendah</option>
            <option value="Sedang">Sedang</option>
            <option value="Tinggi">Tinggi</option>
          </select>
        </div>
      </div>
<div class="tableWrap">
  <table id="banjirTable" class="display compact" style="width:100%">
        <thead>
          <tr>
            <th>No</th>
            <th>Tutupan Lahan</th>
            <th>Kerapatan Sungai</th>
            <th>Jenis Tanah</th>
            <th>Jarak dari Sungai</th>
            <th>Curah Hujan</th>
            <th>Kemiringan Lereng</th>
            <th>Ketinggian Lahan</th>
            <th>Kelas Bahaya Banjir</th>
            <th>Desa/Kelurahan</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
       </div>
      <div class="subtle" style="margin-top:8px">Cari di kotak ‚ÄúCari‚Äù kanan atas ‚Ä¢ Pilih halaman 10, 20, 30, 40, 50, 100 baris.</div>
    </div>

    <!-- ==== GRAFIK + DROPDOWN KHUSUS GRAFIK ==== -->
    <div class="card chartCard">
        <div class="sectionBreak">
  <span>Grafik Analisis Bahaya Banjir</span>
</div>
      <div class="filters" style="justify-content:flex-start; margin-bottom:10px">
        <div class="control">
          <label for="chartKec">Grafik untuk Desa/Kelurahan</label>
          <select id="chartKec"></select>
        </div>
      </div>
      <div class="paramLegend" id="paramLegend"></div>

<canvas id="banjirChart" style="max-height:400px;"></canvas>

<div class="legendNote">
  Tip: Klik salah satu bar pada grafik untuk melihat rincian <b>sub-parameter</b> di bawah.
</div>

<div class="interpretBox">
  <div class="interpretIcon">i</div>
  <div>
    <b>Interpretasi Grafik:</b><br>
    Grafik menampilkan akumulasi luasan (Km¬≤) setiap sub-parameter dalam masing-masing parameter analisis.
    Nilai pada tumpukan grafik tidak merepresentasikan luas wilayah total, melainkan distribusi spasial hasil klasifikasi parameter.
    Seluruh nilai luasan (Km¬≤) diperoleh melalui proses pengolahan data menggunakan teknologi Sistem Informasi Geografis (GIS).
  </div>
</div>



    <!-- ==== DETAIL SUB-PARAMETER ==== -->
<div class="card detailCard" id="detailSection">
      <div id="detailHeader" class="detailHeader">Detail Sub-Parameter (klik bar pada grafik)</div>
      <div id="detailEmpty" class="empty">Belum ada pilihan. Klik salah satu bar pada grafik untuk melihat rincian.</div>
      <table id="detailTable" style="display:none"> 
        <thead>
            
          <tr>
            <th>Sub-Parameter</th>
            <th>Luasan (Km¬≤)</th>
            <th>Persentase</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ===== Konfigurasi kolom & grup =====
    const COLS = {
      no: "No",
      lahan: "Tutupan Lahan",
      kerapatan: "Kerapatan Sungai",
      tanah: "Jenis Tanah",
      jarak: "Jarak dari Sungai",
      hujan: "Curah Hujan",
      lereng: "Kemiringan Lereng",
      ketinggian: "Ketinggian Lahan",
      kelas: "Kelas Bahaya Banjir",
      kec: "Desa/Kelurahan",
      luas: "Luas Km¬≤"
    };
    const KELAS = ["Rendah","Sedang","Tinggi"];

    // Definisi parameter (nama + hue dasar untuk warna)
    const PARAMS = [
  {key: COLS.lahan,        label:"Tutupan Lahan",        hue:145}, // hijau
  {key: COLS.lereng,       label:"Kemiringan Lereng",    hue:35},  // oranye
  {key: COLS.tanah,        label:"Jenis Tanah",          hue:275}, // ungu
  {key: COLS.hujan,        label:"Curah Hujan",          hue:210}, // biru
  {key: COLS.jarak,        label:"Jarak dari Sungai",    hue:10},  // merah bata
  {key: COLS.kerapatan,    label:"Kerapatan Sungai",     hue:175}, // cyan / toska
  {key: COLS.ketinggian,   label:"Ketinggian Lahan",     hue:330}  // magenta lembut
];

    let raw = [];       // data CSV asli (array objek)
    let table = null;   // instance DataTable
    let chart = null;   // instance Chart.js

    // ====== Utils ======
    const hsl = (h,s,l,a=1)=>`hsla(${h},${s}%,${l}%,${a})`;

    function getUnique(arr){
      const s = new Set();
      arr.forEach(v => { if(v!==undefined && v!==null && String(v).trim()!=="") s.add(String(v).trim()); });
      return Array.from(s);
    }

    function groupCount(rows, byKey, where={}){
      // where: { [key]: value } filter sederhana
      const map = new Map();
      rows.forEach(r=>{
        for(const [k,v] of Object.entries(where)){
          if(String(r[k]).trim() !== String(v).trim()) return;
        }
        const key = String(r[byKey] ?? "").trim() || "(Tidak diketahui)";
        map.set(key, (map.get(key)||0) + 1);
      });
      return map; // Map(subValue -> count)
    }

    // Ambil warna turunan per-sub berdasarkan hue parameter
    function colorScale(baseHue, idx, total){
      // variasi lightness berdasarkan urutan sub-parameter
      const l = 65 - Math.min(30, (idx * (38/(Math.max(1,total-1)))));
      const s = 70;
      return hsl(baseHue, s, Math.round(l));
    }

    // ====== Load CSV ======
    Papa.parse("atributbanjirfixx.csv", {
      download:true,
      header:true,
      skipEmptyLines: "greedy",
      transformHeader: h => (h || "").trim(),
      transform: v => (typeof v === "string" ? v.trim() : v),
      complete: (res)=>{
        // buang baris kosong (tanpa kecamatan)
        raw = res.data.filter(r => r[COLS.kec] && r[COLS.kec].trim() !== "");
        initTable(raw);
        initFilters(raw);
        initChartDropdown(raw);
        renderChartForKec(document.getElementById("chartKec").value);
      }
    });

    // ====== DataTable ======
    function initTable(data){
      table = $("#banjirTable").DataTable({
        data,
  deferRender:true,
  pageLength:10,
  lengthMenu:[10,20,30,40,50,100],

  language: {
    search: "Cari:",
    lengthMenu: "Tampilkan _MENU_ entri",
    info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
    infoEmpty: "Menampilkan 0 sampai 0 dari 0 entri",
    infoFiltered: "(difilter dari _MAX_ total entri)",
    zeroRecords: "Data tidak ditemukan",
    paginate: {
      first: "Pertama",
      last: "Terakhir",
      next: "Berikutnya",
      previous: "Sebelumnya"
    }
  },

  columns:[
{ 
  data: null,
  title: "No",
  render: (data, type, row, meta) => meta.row + 1
},          { data: COLS.lahan, title:"Tutupan Lahan" },
          { data: COLS.kerapatan, title:"Kerapatan Sungai" },
          { data: COLS.tanah, title:"Jenis Tanah" },
          { data: COLS.jarak, title:"Jarak dari Sungai" },
          { data: COLS.hujan, title:"Curah Hujan" },
          { data: COLS.lereng, title:"Kemiringan Lereng" },
          { data: COLS.ketinggian, title:"Ketinggian Lahan" },
          { data: COLS.kelas, title:"Kelas Bahaya Banjir" },
          { data: COLS.kec, title:"Desa/Kelurahan" }
        ]
      });

      // Filter dropdown tabel
     $("#filterKec").on("change", function(){
  table.column(9).search(this.value).draw(); // Desa
});
$("#filterKelas").on("change", function(){
  table.column(8).search(this.value).draw(); // Kelas Bahaya
});
    }

    function initFilters(data){
      // isi opsi kecamatan untuk filter TABEL
      const listKec = getUnique(data.map(d=>d[COLS.kec])).sort((a,b)=>a.localeCompare(b,'id'));
      const sel = document.getElementById("filterKec");
      sel.innerHTML = `<option value="">Semua</option>` + listKec.map(k=>`<option value="${k}">${k}</option>`).join("");
    }

    // ====== Dropdown khusus grafik ======
    function initChartDropdown(data){
      const listKec = getUnique(data.map(d=>d[COLS.kec])).sort((a,b)=>a.localeCompare(b,'id'));
      const sel = document.getElementById("chartKec");
      sel.innerHTML = `<option value="">Semua</option>` + listKec.map(k=>`<option value="${k}">${k}</option>`).join("");
      sel.addEventListener("change", ()=> renderChartForKec(sel.value));
    }

    // ====== Bangun dataset Grouped + Stacked (stack per-parameter, isi = sub-parameter) ======
    function buildGroupedStackDatasets(rows){
      const datasets = [];
      PARAMS.forEach((p, pIdx)=>{
        // daftar sub-parameter yang ada pada data terfilter
        const subs = getUnique(rows.map(r=>r[p.key]));
        // urutkan sub berdasarkan total keseluruhan (biar konsisten)
        const totalPerSub = subs.map(s=>({
          sub: s,
          total: rows.filter(r=> (r[p.key]||"").trim()===s).length
        })).sort((a,b)=> b.total - a.total);

        totalPerSub.forEach((obj, sIdx)=>{
          const dataForClasses = KELAS.map(kls => rows.filter(r =>
            String(r[COLS.kelas]).trim()===kls && String(r[p.key]||"").trim()===obj.sub
          )
        .reduce((sum, r) => sum + parseFloat(r[COLS.luas] || 0), 0) || 0.0001

        );

          datasets.push({
            label: `${p.label}: ${obj.sub}`,
            stack: p.label,                   // <== grup stack per-parameter
            data: dataForClasses,
             minBarLength: 4,
            backgroundColor: colorScale(p.hue, sIdx, Math.max(1,totalPerSub.length)),
            borderColor: "#00000020",
            borderWidth: 1.2
          });
        });
      });
      return datasets;
    }

    function renderChartForKec(kecValue){
      // filter sumber data untuk grafik khusus dropdown grafik
      const chartRows = kecValue ? raw.filter(r => String(r[COLS.kec]).trim()===kecValue) : raw;

      // bangun datasets grouped-stack (tiap parameter punya beberapa dataset = sub-parameter)
      const datasets = buildGroupedStackDatasets(chartRows);


      // hancurkan chart lama
if(chart) chart.destroy();

renderParamLegend();   // üî• INI YANG KURANG

      chart = new Chart(document.getElementById("banjirChart"), {
        type: "bar",
        data: { labels: KELAS, datasets },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          interaction:{ mode: 'nearest', intersect: true },
          plugins:{
            legend:{ display:false }, // legend bisa terlalu panjang; detail muncul saat klik
            tooltip:{
              callbacks:{
                title: (ctx)=> `Kelas: ${ctx[0].label}`,
                label: (ctx)=>{
                  const ds = ctx.dataset;
                  const stackName = ds.stack; // nama parameter
                  const kelasIndex = ctx.dataIndex;
                  // jumlah stack (total semua sub dari parameter tsb pada kelas yang sama)
                  let stackSum = 0;
                  ctx.chart.data.datasets.forEach(d=>{
                    if(d.stack===stackName) stackSum += (d.data[kelasIndex]||0);
                  });
                  const val = ctx.raw || 0;
                  const pct = stackSum>0 ? (val/stackSum*100).toFixed(1)+"%" : "0%";
                  return `${ds.label} ‚Äî ${val} (${pct} dari ${stackName})`;
                }
              }
            }
          },
          scales:{
  x:{ 
    stacked:true,
    grid:{ 
  color:"rgba(0,0,0,0.06)",
  drawBorder:false
},

    title:{
      display:true,
      text:"Kelas Bahaya Banjir",
      color:"#6b7280",
      font:{ size:12, weight:'600' }
    }
  },

  y:{ 
    stacked:true,
    beginAtZero:true,
    grid:{ 
  color:"rgba(0,0,0,0.06)",
  drawBorder:false
},

    title:{
      display:true,
      text:"Luasan (Km¬≤)",
      color:"#6b7280",
      font:{ size:12, weight:'600' }
    },

    ticks:{ precision:0, stepSize:2 }
  }
},

         onClick: (evt, elements)=>{
  if(!elements.length) return;

  const el = elements[0];
  const ds = chart.data.datasets[el.datasetIndex];
  const kelas = chart.data.labels[el.index];
  const paramLabel = ds.stack;
  const paramDef = PARAMS.find(p=>p.label===paramLabel);
  if(!paramDef) return;

  // tampilkan detail
  showDetail(chartRows, paramDef, kelas);

  // === LINK VISUAL KE DETAIL ===
  const detail = document.getElementById("detailSection");

  // scroll halus ke detail
  detail.scrollIntoView({ behavior: "smooth", block: "start" });

  // trigger efek highlight
  detail.classList.remove("detail-focus");
  void detail.offsetWidth; // reset animasi
  detail.classList.add("detail-focus");
}
        }
      });

      // reset panel detail saat ganti grafik
      resetDetail();
    }

    // ====== Panel detail sub-parameter ======
    function resetDetail(){
      document.getElementById("detailHeader").textContent = "Detail Sub-Parameter (klik bar pada grafik)";
      document.getElementById("detailTable").style.display = "none";
      document.getElementById("detailEmpty").style.display = "block";
      document.getElementById("detailBody").innerHTML = "";
    }

    function showDetail(rows, paramDef, kelas){

  // Filter berdasarkan kelas bahaya
  const rowsKelas = rows.filter(r => String(r[COLS.kelas]).trim() === kelas);

  // Hitung akumulasi luas per sub-parameter
  const map = new Map();

  rowsKelas.forEach(r => {
    const key  = String(r[paramDef.key] || "(Tidak diketahui)");
    const luas = parseFloat(r[COLS.luas] || 0);

    map.set(key, (map.get(key) || 0) + luas);
  });

  // Total luas
  const total = Array.from(map.values()).reduce((a,b) => a + b, 0);

  // Urutkan terbesar ‚Üí terkecil
  const pairs = Array.from(map.entries())
                     .sort((a,b) => b[1] - a[1]);

  // Render header
  document.getElementById("detailHeader").textContent =
    `Detail Sub-Parameter ‚Äî ${paramDef.label} ‚Ä¢ Kelas ${kelas}`;

  const tbody = document.getElementById("detailBody");
  tbody.innerHTML = "";

  pairs.forEach(([sub, val]) => {

    const subsAll = getUnique(rows.map(r => r[paramDef.key]));

    const ordered = subsAll.map(s => ({
      sub: s,
      total: rows.filter(r => (r[paramDef.key] || "").trim() === s).length
    })).sort((a,b) => b.total - a.total);

    const sIndex = ordered.findIndex(o => o.sub === sub);

    const color = colorScale(
      paramDef.hue,
      Math.max(0, sIndex),
      Math.max(1, ordered.length)
    );

    const pct = total > 0 ? (val / total * 100).toFixed(1) + "%" : "0%";

    tbody.insertAdjacentHTML("beforeend",
      `<tr>
        <td><span class="swatch" style="background:${color}"></span>${sub}</td>
        <td>${val.toFixed(4)}</td>
        <td>${pct}</td>
      </tr>`
    );
  });

  document.getElementById("detailEmpty").style.display = "none";
  document.getElementById("detailTable").style.display = "table";
}

    // ====== Mobile Mode Handler ======
 function enableMobileMode(){
  document.getElementById('mobileWarning').style.display='none';
  document.body.classList.add('mobile-mode');
  
}
function renderParamLegend(){
  const box = document.getElementById("paramLegend");

  box.innerHTML = PARAMS.map(p => `
    <div class="paramItem">
      <span class="paramColor" style="background:${hsl(p.hue,70,55)}"></span>
      ${p.label}
    </div>
  `).join("");
}

  </script>
</body>
</html>
